# 1UP Configuration - Local Development
# âš ï¸ CONFIGURACIÃ“N ACTUAL: Mac Intel + CPU + Stream 4K HEVC (MÃ¡xima Calidad para Crops)
# Los errores HEVC son warnings de FFmpeg, no bloquean el procesamiento
# SAM 3 procesa a 720p (optimizaciÃ³n), pero crops se extraen del 4K original
# Ver docs/4K_HEVC_SOLUCION.md para detalles completos

camera:
  # Source can be:
  #   - Integer index (0, 1, 2...) for USB/webcam cameras
  #   - RTSP URL string (e.g., "rtsp://user:pass@ip:port/stream") for IP cameras
  # 
  # âš ï¸ IMPORTANTE: Mac Intel (2018) tiene MUCHOS problemas decodificando HEVC 4K
  # - Stream main (4K HEVC): h264Preview_01_main - Errores HEVC, frames corruptos, muy lento (30s+ por frame)
  # - Stream sub (1080p H.264): h264Preview_01_sub - Estable, sin errores, frames limpios
  #
  # âœ… CONFIGURACIÃ“N ACTUAL: 1080p H.264 para estabilidad (elimina errores HEVC y pixelaciÃ³n)
  # 1080p sigue siendo excelente calidad para crops, y SAM 3 funciona bien a esta resoluciÃ³n
  # Para 4K: Cambiar a stream main + usar Mac Apple Silicon (M1/M2/M3) con MPS
  source: "rtsp://admin:Polic!ia1@192.168.1.188:8554/h264Preview_01_sub"  # Stream sub 1080p H.264 (estable, sin errores)
  resolution: [1920, 1080]  # â¬‡ï¸ 1080p H.264 (estable en Mac Intel, elimina errores HEVC y pixelaciÃ³n)
  fps: 5  # âœ… Aumentado a 5 (1080p H.264 es mÃ¡s rÃ¡pido que 4K HEVC)
  buffer_size: 1  # Buffer size for RTSP streams (reduces latency, use 1 for live detection)
  allow_iphone: true  # Set to true to allow iPhone/Continuity Camera (default: false to avoid interfering with phone)
  # Note: If you set source to 1 or 2 (iPhone), it will be used even if allow_iphone is false
  # If preferred camera not found, system will use any available camera as fallback
  # For RTSP: Use source as full URL, resolution should match camera stream resolution
  
  # Image quality validation (mathematical blur detection)
  quality_check:
    enabled: true  # Enable automatic blur detection
    min_sharpness: 20.0  # Laplacian variance threshold (images below this will be rejected)
    warning_sharpness: 50.0  # Threshold for warning (images below this will show warning but continue)
    # Sharpness scores: >100 = buena, 50-100 = aceptable (warning), 20-50 = borrosa (warning), <20 = muy borrosa (rechazar)
  
  # âš ï¸ TEMPORAL: Smart autofocus for external USB camera
  # TODO: Eliminar cuando se implemente app mÃ³vil o sistema automÃ¡tico
  autofocus:
    enabled: false  # Enable intelligent autofocus (TEMPORAL - only for external USB camera)
    autofocus_delay: 2.0  # Seconds to wait after triggering autofocus
    focus_attempts: 5  # Number of frames to capture to pick the sharpest
    max_autofocus_attempts: 3  # Maximum autofocus attempts if image is blurry

sam3:
  # âš ï¸ Mac Intel (2018) NO tiene MPS (Metal Performance Shaders) - usar CPU
  # - Intel Macs (pre-2020): Solo CPU disponible
  # - Apple Silicon (M1/M2/M3): Puede usar "mps" (mÃ¡s rÃ¡pido) o "cpu"
  # - NVIDIA GPUs: Usar "cuda"
  #
  # ðŸ”„ Para usar MPS (solo Mac Apple Silicon):
  #    device: "mps"  # Cambiar a "mps" si tienes Mac M1/M2/M3
  device: "cpu"  # Mac Intel usa CPU (funciona pero mÃ¡s lento que MPS)
  
  # SAM 3 uses text prompts for concept-based detection
  # Leave empty for automatic detection (uses "visual" prompt internally)
  # Or specify concepts like: "bag", "shoes", "electronics", "furniture", "rectangle", "shape", "round", "dark object"
  # Note: For better detection of dark/round objects (like kettlebell), try: "round object" or "dark object"
  text_prompt: ""  # Empty = automatic detection, or specify concept
  
  # Image enhancement (improves detection of dark objects)
  enhance_image: true  # CLAHE pre-processing - ACTIVADO para detectar objetos oscuros (kettlebell, etc.)
  
  # Smart filtering (PRE-Claude, MINIMAL - let Claude do intelligent filtering)
  # FILOSOFÃA: "SAM detecta TODO, Claude decide quÃ© entra"
  # Filtros mÃ­nimos: solo eliminar duplicados exactos y objetos extremadamente pequeÃ±os
  filtering:
    enabled: false  # DISABLED - SAM detecta TODO, Claude decide
    min_area: 50  # Minimum object area in pixelsÂ² (muy bajo para detectar TODO)
    max_area_ratio: 0.9  # Maximum area as ratio of image (90%, permite objetos grandes)
    min_aspect_ratio: 0.01  # Minimum width/height ratio (permite objetos muy alargados)
    max_aspect_ratio: 50.0  # Maximum width/height ratio (permite objetos muy largos)
    nms_iou_threshold: 0.9  # NMS threshold (muy alto, solo elimina duplicados exactos)
  
  # Pre-filtering before Claude analysis - DISABLED
  # Claude will receive ALL objects detected by SAM
  min_area_for_analysis: 0  # NO FILTER - send ALL objects to Claude
  max_objects_for_analysis: 1000  # Send up to 1000 objects to Claude (sin lÃ­mite prÃ¡ctico)

claude:
  api_key_env: "CLAUDE_API_KEY"  # Read from environment variable
  model: "claude-sonnet-4-20250514"
  max_tokens: 16000  # Increased for large batches (255 objects need ~15k tokens)
  temperature: 0  # Deterministic output

paths:
  raw_images: "images/raw"
  crops: "images/crops"
  database: "database/objects.json"

cleanup:
  enabled: false  # Automatic cleanup disabled by default (scenes may be valuable long-term)
  keep_days: 30  # If enabled, keep scenes from last N days
  keep_useful_only: true  # Only keep crops from useful objects (in database)
  # Note: Use cleanup_images.py manually if needed

# Testing mode: Auto-delete images at startup only (for development/testing only)
testing:
  auto_cleanup: true  # âš ï¸ TESTING MODE: Clean at startup, keep images during session
  # Images are deleted at startup, but kept during session for web display
  # Set to false to keep images permanently

logging:
  level: "INFO"  # DEBUG | INFO | WARNING | ERROR
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

